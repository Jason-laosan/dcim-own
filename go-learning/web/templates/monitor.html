<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶ç›‘æ§ - TaskHub</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>TaskHub</h1>
            <ul class="nav-links">
                <li><a href="/">é¦–é¡µ</a></li>
                <li><a href="/tasks">ä»»åŠ¡ç®¡ç†</a></li>
                <li><a href="/files">æ–‡ä»¶ç®¡ç†</a></li>
                <li><a href="/monitor" class="active">å®æ—¶ç›‘æ§</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <h2>å®æ—¶ç›‘æ§ï¼ˆSSE æ¼”ç¤ºï¼‰</h2>
        <p class="subtitle">ä½¿ç”¨ Server-Sent Events å®æ—¶æ¨é€ç³»ç»ŸçŠ¶æ€å’Œä»»åŠ¡ä¿¡æ¯</p>

        <!-- è¿æ¥çŠ¶æ€ -->
        <section class="status-section">
            <div class="connection-status">
                <span id="connection-indicator" class="indicator disconnected"></span>
                <span id="connection-text">æœªè¿æ¥</span>
            </div>
        </section>

        <!-- ç³»ç»Ÿç»Ÿè®¡ -->
        <section class="stats-section">
            <h3>ç³»ç»Ÿç»Ÿè®¡</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ”„</div>
                    <div class="stat-content">
                        <h4>åç¨‹æ•°é‡</h4>
                        <p id="goroutines" class="stat-value">-</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ’¾</div>
                    <div class="stat-content">
                        <h4>å†…å­˜ä½¿ç”¨</h4>
                        <p id="memory" class="stat-value">-</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ—‘ï¸</div>
                    <div class="stat-content">
                        <h4>GC æ¬¡æ•°</h4>
                        <p id="gc-count" class="stat-value">-</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">âš¡</div>
                    <div class="stat-content">
                        <h4>å¤„ç†ä¸­ä»»åŠ¡</h4>
                        <p id="processing-tasks" class="stat-value">-</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ä»»åŠ¡ç»Ÿè®¡ -->
        <section class="stats-section">
            <h3>ä»»åŠ¡ç»Ÿè®¡</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“‹</div>
                    <div class="stat-content">
                        <h4>å¾…å¤„ç†</h4>
                        <p id="pending-count" class="stat-value">-</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">â³</div>
                    <div class="stat-content">
                        <h4>å¤„ç†ä¸­</h4>
                        <p id="processing-count" class="stat-value">-</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-content">
                        <h4>å·²å®Œæˆ</h4>
                        <p id="completed-count" class="stat-value">-</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- äº‹ä»¶æ—¥å¿— -->
        <section class="log-section">
            <div class="section-header">
                <h3>äº‹ä»¶æ—¥å¿—</h3>
                <button onclick="clearLog()" class="btn btn-secondary">æ¸…ç©º</button>
            </div>
            <div id="event-log" class="event-log"></div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>TaskHub - Go è¯­è¨€å­¦ä¹ é¡¹ç›®</p>
        </div>
    </footer>

    <script>
        let systemEventSource = null;
        let taskEventSource = null;
        const maxLogEntries = 50;

        // è¿æ¥åˆ°ç³»ç»ŸçŠ¶æ€ SSE
        function connectSystemSSE() {
            if (systemEventSource) {
                systemEventSource.close();
            }

            systemEventSource = new EventSource('/api/sse/system');

            systemEventSource.onopen = function() {
                updateConnectionStatus(true);
                addLog('ç³»ç»ŸçŠ¶æ€ SSE è¿æ¥æˆåŠŸ', 'success');
            };

            systemEventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);

                    document.getElementById('goroutines').textContent = data.goroutines || '-';
                    document.getElementById('memory').textContent = (data.memory_mb || 0) + ' MB';
                    document.getElementById('gc-count').textContent = data.gc_count || '-';
                    document.getElementById('processing-tasks').textContent = data.processing_tasks || '0';

                    addLog(`ç³»ç»ŸçŠ¶æ€æ›´æ–°: åç¨‹=${data.goroutines}, å†…å­˜=${data.memory_mb}MB`, 'info');
                } catch (error) {
                    console.error('è§£æç³»ç»ŸçŠ¶æ€æ•°æ®å¤±è´¥:', error);
                }
            };

            systemEventSource.onerror = function(error) {
                console.error('ç³»ç»ŸçŠ¶æ€ SSE è¿æ¥é”™è¯¯:', error);
                updateConnectionStatus(false);
                addLog('ç³»ç»ŸçŠ¶æ€ SSE è¿æ¥æ–­å¼€ï¼Œ5ç§’åé‡è¿...', 'error');

                setTimeout(() => {
                    connectSystemSSE();
                }, 5000);
            };
        }

        // è¿æ¥åˆ°ä»»åŠ¡çŠ¶æ€ SSE
        function connectTaskSSE() {
            if (taskEventSource) {
                taskEventSource.close();
            }

            taskEventSource = new EventSource('/api/sse/tasks');

            taskEventSource.onopen = function() {
                addLog('ä»»åŠ¡çŠ¶æ€ SSE è¿æ¥æˆåŠŸ', 'success');
            };

            taskEventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);

                    document.getElementById('pending-count').textContent = data.pending_count || '0';
                    document.getElementById('processing-count').textContent = data.processing_count || '0';
                    document.getElementById('completed-count').textContent = data.completed_count || '0';

                    addLog(`ä»»åŠ¡çŠ¶æ€æ›´æ–°: å¾…å¤„ç†=${data.pending_count}, å¤„ç†ä¸­=${data.processing_count}, å·²å®Œæˆ=${data.completed_count}`, 'info');
                } catch (error) {
                    console.error('è§£æä»»åŠ¡çŠ¶æ€æ•°æ®å¤±è´¥:', error);
                }
            };

            taskEventSource.onerror = function(error) {
                console.error('ä»»åŠ¡çŠ¶æ€ SSE è¿æ¥é”™è¯¯:', error);
                addLog('ä»»åŠ¡çŠ¶æ€ SSE è¿æ¥æ–­å¼€ï¼Œ5ç§’åé‡è¿...', 'error');

                setTimeout(() => {
                    connectTaskSSE();
                }, 5000);
            };
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connection-indicator');
            const text = document.getElementById('connection-text');

            if (connected) {
                indicator.className = 'indicator connected';
                text.textContent = 'å·²è¿æ¥';
            } else {
                indicator.className = 'indicator disconnected';
                text.textContent = 'æœªè¿æ¥';
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const log = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString('zh-CN');

            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-time">${timestamp}</span> <span class="log-message">${message}</span>`;

            log.insertBefore(entry, log.firstChild);

            // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
            while (log.children.length > maxLogEntries) {
                log.removeChild(log.lastChild);
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('event-log').innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶è¿æ¥ SSE
        window.addEventListener('load', () => {
            connectSystemSSE();
            connectTaskSSE();
        });

        // é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
        window.addEventListener('beforeunload', () => {
            if (systemEventSource) {
                systemEventSource.close();
            }
            if (taskEventSource) {
                taskEventSource.close();
            }
        });
    </script>
</body>
</html>
